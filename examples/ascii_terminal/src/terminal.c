#include <avr/pgmspace.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#include "../inc/defs.h"
#include "../inc/gfx.h"
#include "../inc/kb.h"
#include "../inc/uart.h"

#define LINE_BUFF_SIZE 61

// key mods
#define KM_SHIFT  0x01
#define KM_CTRL  0x02

// special keys
#define SK_F1 0x05
#define SK_F2 0x06
#define SK_F3 0x04
#define SK_F4 0x0C
#define SK_F5 0x03

#define SK_BS 0x08
#define SK_RT 0x0a


const PROGMEM uint8_t  SC_MAP[]  = {
//0     1     2     3     4     5     6     7     8     9     a     b     c     d     e     f
  0x00, 0x00, 0x00,SK_F5,SK_F3,SK_F1,SK_F2, 0x00, 0x00, 0x00, 0x00, 0x00,SK_F4, '\t',  '`', 0x00,   //0x0
  0x00, 0x00, 0x00, 0x00, 0x00,  'q',  '1', 0x00, 0x00, 0x00,  'z',  's',  'a',  'w',  '2', 0x00,   //0x1
  0x00,  'c',  'x',  'd',  'e',  '4',  '3', 0x00, 0x00,  ' ',  'v',  'f',  't',  'r',  '5', 0x00,   //0x2
  0x00,  'n',  'b',  'h',  'g',  'y',  '6', 0x00, 0x00, 0x00,  'm',  'j',  'u',  '7',  '8', 0x00,   //0x3
  0x00,  ',',  'k',  'i',  'o',  '0',  '9', 0x00, 0x00,  '.', '/',  'l',   ';',  'p',  '-', 0x00,   //0x4
  0x00, 0x00, '\'', 0x00,  '[',  '=', 0x00, 0x00, 0x00, 0x00,SK_RT,  ']', 0x00, '\\', 0x00, 0x00,   //0x5
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,SK_BS, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0x6
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0x7
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0x8
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0x9
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xa
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xb
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xc
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xd
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xe
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xf
};


const PROGMEM uint8_t  SC_UC_MAP[]  = {
//0     1     2     3     4     5     6     7     8     9     a     b     c     d     e     f
  0x00, 0x00, 0x00,SK_F5,SK_F3,SK_F1,SK_F2, 0x00, 0x00, 0x00, 0x00, 0x00,SK_F4, '\t',  '~', 0x00,   //0x0
  0x00, 0x00, 0x00, 0x00, 0x00,  'Q',  '!', 0x00, 0x00, 0x00,  'Z',  'S',  'A',  'W',  '@', 0x00,   //0x1
  0x00,  'C',  'X',  'D',  'E',  '$',  '#', 0x00, 0x00,  ' ',  'V',  'F',  'T',  'R',  '%', 0x00,   //0x2
  0x00,  'N',  'B',  'H',  'G',  'Y',  '^', 0x00, 0x00, 0x00,  'M',  'J',  'K',  '&',  '*', 0x00,   //0x3
  0x00,  '<',  'K',  'I',  'O',  ')',  '(', 0x00, 0x00,  '>', '?',  'L',   ':',  'P',  '_', 0x00,   //0x4
  0x00, 0x00, '"',  0x00,  '{',  '+', 0x00, 0x00, 0x00, 0x00,SK_RT,  '}', 0x00,  '|', 0x00, 0x00,   //0x5
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,SK_BS, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0x6
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0x7
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0x8
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0x9
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xa
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xb
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xc
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xd
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xe
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   //0xf
};


void input_handler(uint8_t k, uint8_t m);
void kb_handler(uint8_t scan_code);
uint8_t COMMAND_PROMPT = '>';

volatile uint8_t LINE_BUFFER_1[LINE_BUFF_SIZE];
volatile uint8_t LINE_BUFFER_2[LINE_BUFF_SIZE];

volatile uint8_t *SEND_BUFFER;
volatile uint8_t *INPUT_BUFFER;

void initialize()
{
    memset((uint8_t*)LINE_BUFFER_1, 0, LINE_BUFF_SIZE);
    memset((uint8_t*)LINE_BUFFER_2, 0, LINE_BUFF_SIZE);
    SEND_BUFFER = LINE_BUFFER_1;
    INPUT_BUFFER = LINE_BUFFER_2;

    _delay_ms(500);
    gfx_init();
    _delay_ms(500);

    gfx_clear_inv();
    gfx_clear_src(0);

    kb_init(&kb_handler);
    uart_init();

    sei();
}

void transmit_send_buffer()
{
    if(*SEND_BUFFER != 0x00) {
        uart_send((uint8_t*)SEND_BUFFER, LINE_BUFF_SIZE);
        memset((uint8_t*)SEND_BUFFER, 0x00, LINE_BUFF_SIZE);
    }
}

int main()
{
    initialize();
    gfx_set_glyph_addr(0, 57);
    gfx_put_string("> ");

    // _delay_ms(1000);
    // kb_send_cmd(0xed);
    // kb_send_cmd(0x01);
    // gfx_put_string(" .. done ... ");
    gfx_setup_ext_cmd(0, 0, 61, 58, 0);

    for(;;) {
        transmit_send_buffer();
    }
}

void kb_handler(uint8_t scan_code)
{
    static uint8_t sc_ignore_next = 0;
    static uint8_t sc_release = 0;
    static uint8_t sc_extended = 0;
    static uint8_t sc_mod = 0x00;
    
    if(sc_ignore_next > 0)
    {
        sc_ignore_next--;
        return;
    }

    if(scan_code == RSC_PAUSE_EXT_SC)
    {
        sc_ignore_next = 7;
        return;
    }

    if(scan_code == RSC_RELEASE)
    {
        sc_release = 0x01;
        return;
    }

    if(scan_code == RSC_EXTENDED_SC)
    {
        sc_extended = 0x01;
        return;
    }

    if(scan_code == RSC_CTRL)
    {
        if(sc_release)
        {
            sc_mod &= ~KM_CTRL;
        }
        else
        {
            sc_mod |= KM_CTRL;
        }
    }
    else if(scan_code == RSC_LSHIFT || scan_code == RSC_RSHIFT)
    {
        if(sc_release)
        {
            sc_mod &= ~KM_SHIFT;
        }
        else
        {
            sc_mod |= KM_SHIFT;
        }
    }
    else if(!sc_release && !sc_extended)
    {
        uint8_t data;
        if(sc_mod & KM_SHIFT)
            data = pgm_read_byte(SC_UC_MAP + scan_code);
        else
            data = pgm_read_byte(SC_MAP + scan_code);
        
        input_handler(data, sc_mod);
    }
    
    sc_release = 0;
    sc_extended = 0;
}


uint8_t inv_flag = 0x00;
uint8_t caret_col = 0x00;
void input_handler(uint8_t k, uint8_t m)
{
    if(k == 0)
        return;

    if(k == SK_RT)
    {
        gfx_push_scr(GFX_PUSH_DIR_UP);
        gfx_set_glyph_addr(0, 57);
        gfx_put_ext('>', 1);
        
        INPUT_BUFFER[caret_col] = '\n';

        caret_col = 0;

        if(SEND_BUFFER == LINE_BUFFER_1)
        {
            SEND_BUFFER = LINE_BUFFER_2;
            INPUT_BUFFER = LINE_BUFFER_1;
        }
        else
        {
            SEND_BUFFER = LINE_BUFFER_1;
            INPUT_BUFFER = LINE_BUFFER_2;
        }

        return;
    }

    if(k == SK_BS)
    {
        if(caret_col > 0)
        {
            gfx_put_ext(0x00, -1);
            caret_col--;
            INPUT_BUFFER[caret_col] = 0x00;
            gfx_set_glyph_addr(caret_col+1, 57);
        }
        return;
    }

    if(m & KM_CTRL)
    {
        if(k == SK_F1)
        {
            
            return;
        }
        if(k == SK_F5)
        {
            inv_flag = ~inv_flag;
            gfx_fill_inv(inv_flag);
            gfx_set_glyph_addr(caret_col+1, 57);
            return;
        }
    }

    gfx_put(k);
    INPUT_BUFFER[caret_col] = k;
    caret_col++;
}
